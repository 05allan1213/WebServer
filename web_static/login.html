<!DOCTYPE html>
<html>

<head>
    <title>登录</title>
    <link rel="stylesheet" href="/style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <header>
        <h1>WebServer</h1>
        <p>高性能C++服务器演示</p>
    </header>
    <div class="container">
        <nav>
            <a href="/index.html">首页</a>
            <a href="/about.html">关于我</a>
            <a href="/contact.html">联系我们</a>
            <a href="/register.html">注册</a>
        </nav>
        <div class="card" style="max-width:400px;margin:2rem auto;">
            <h2>账号登录</h2>
            <form id="loginForm" autocomplete="off">
                <div style="margin-bottom:1rem;">
                    <input type="text" name="username" placeholder="用户名" required style="width:100%;padding:0.5rem;">
                </div>
                <div style="margin-bottom:1rem;">
                    <input type="password" name="password" placeholder="密码" required minlength="6"
                        style="width:100%;padding:0.5rem;">
                </div>
                <button class="btn" id="loginBtn" type="submit" style="width:100%;">登录</button>
                <div id="loginMsg" style="margin-top:1rem;color:var(--accent-color);"></div>
            </form>
            <p style="margin-top:1rem;font-size:0.95rem;">没有账号？<a href="/register.html"
                    style="color:var(--primary-color);">去注册</a></p>
        </div>
    </div>
    <footer>
        <div class="container">
            <p>© 2023 WebServer 项目演示</p>
        </div>
    </footer>
    <script>
        const form = document.getElementById('loginForm');
        const btn = document.getElementById('loginBtn');
        const msg = document.getElementById('loginMsg');
        form.onsubmit = async function (e) {
            e.preventDefault();
            msg.style.color = 'var(--accent-color)';
            msg.textContent = '';
            const username = form.username.value.trim();
            const password = form.password.value;
            if (!username || !password) {
                msg.textContent = '请填写所有字段';
                return;
            }
            if (password.length < 6) {
                msg.textContent = '密码至少6位';
                return;
            }
            btn.disabled = true;
            btn.textContent = '登录中...';
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                let data = {};
                try {
                    data = await res.json();
                } catch (err) {
                    data = {};
                }
                if (res.ok) {
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                    }
                    msg.style.color = 'green';
                    msg.textContent = '登录成功，正在跳转...';
                    setTimeout(() => { window.location.href = '/index.html'; }, 1200);
                } else {
                    msg.textContent = data.error || data.message || '登录失败';
                }
            } catch (err) {
                msg.textContent = '网络错误，请稍后重试';
            }
            btn.disabled = false;
            btn.textContent = '登录';
        };
    </script>
</body>

</html>